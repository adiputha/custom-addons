<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Custom paper format with minimal top margin -->
    <record id="paperformat_reimbursement_top" model="report.paperformat">
        <field name="name">Reimbursement Report Top Aligned</field>
        <field name="default" eval="False" />
        <field name="format">A4</field>
        <field name="page_height">0</field>
        <field name="page_width">0</field>
        <field name="orientation">Portrait</field>
        <field name="margin_top">10</field>
        <field name="margin_bottom">15</field>
        <field name="margin_left">15</field>
        <field name="margin_right">15</field>
        <field name="header_line" eval="False" />
        <field name="header_spacing">5</field>
        <field name="dpi">90</field>
    </record>

    <template id="reimbursement_report_template">
        <t t-call="web.html_container">
            
            <div class="article">
                
                <style>
                    body {
                    margin: 0 !important;
                    padding: 0 !important;
                    }
                    .article {
                    margin: 0 !important;
                    padding: 0 !important;
                    page-break-inside: avoid;
                    }
                    .page {
                    font-size: 12px;
                    line-height: 1.3;
                    margin: 0 !important;
                    padding: 10px !important;
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    }
                    .table {
                    margin-bottom: 8px !important;
                    width: 100%;
                    }
                    .table th, .table td {
                    padding: 4px !important;
                    border: 1px solid #ddd;
                    font-size: 11px;
                    }
                    h3 {
                    margin: 0 0 5px 0 !important;
                    font-size: 16px;
                    }
                    h4 {
                    margin: 0 0 5px 0 !important;
                    font-size: 14px;
                    }
                    h5, h6 {
                    margin: 8px 0 4px 0 !important;
                    font-size: 12px;
                    }
                    p {
                    margin: 2px 0 !important;
                    font-size: 11px;
                    }
                    .alert {
                    padding: 6px !important;
                    margin: 5px 0 !important;
                    }
                    .row {
                    margin: 0 !important;
                    }
                    .col-6, .col-8, .col-4 {
                    padding: 0 5px !important;
                    }
                    .text-center {
                    text-align: center;
                    }
                    .text-end, .text-right {
                    text-align: right;
                    }
                    .fw-bold {
                    font-weight: bold;
                    }
                    .table-light {
                    background-color: #f8f9fa;
                    }
                    .table-info {
                    background-color: #C6B7B1;
                    }
                    .alert-primary {
                    background-color: #cff4fc;
                    border: 1px solid #b6effb;
                    }
                    .text-muted {
                    color: #6c757d;
                    }
                </style>

                <div class="page">
                    <!-- Get data from context -->
                    <t t-set="reimbursement" t-value="docs and docs[0] or False" />
                    <t t-set="petty_cash_data" t-value="context.get('petty_cash_data') or []" />
                    <t t-set="iou_data" t-value="context.get('iou_data') or []" />
                    <t t-set="report_summary" t-value="context.get('report_summary') or {}" />
                    <t t-set="reimbursement_info" t-value="context.get('reimbursement_info') or {}" />

                    <!-- Get dates -->
                    <t t-set="report_from_date"
                        t-value="
                        reimbursement_info.get('report_from_date') or 
                        (reimbursement and reimbursement.report_from_date and reimbursement.report_from_date.strftime('%Y-%m-%d')) or 
                        'N/A'" />
                    <t t-set="report_to_date"
                        t-value="
                        reimbursement_info.get('report_to_date') or 
                        (reimbursement and reimbursement.report_to_date and reimbursement.report_to_date.strftime('%Y-%m-%d')) or 
                        'N/A'" />

                    <!-- Header - No extra spacing -->
                    <div class="text-center">
                        <h3>GSMB Technical Services (PVT) LTD</h3>
                        <h4>Petty Cash Float Reimbursement Report</h4>
                        <p>(Period: <span t-esc="report_from_date" /> - <span t-esc="report_to_date" />
                            )</p>
                    </div>

                    <!-- Float Information -->
                    <table style="width: 100%; margin: 8px 0;">
                        <tr>
                            <td style="width: 50%; vertical-align: top; padding: 0;">
                                <p>
                                    <strong>Float:</strong>
                                    <span t-esc="reimbursement_info.get('float_name', 'N/A')" />
                                </p>
                                <p>
                                    <strong>Handler:</strong>
                                    <span t-esc="reimbursement_info.get('handler_name', 'N/A')" />
                                </p>
                            </td>
                            <td
                                style="width: 50%; vertical-align: top; text-align: right; padding: 0;">
                                <p><strong>Float Amount:</strong> Rs. <span
                                        t-esc="'{:,.2f}'.format(reimbursement_info.get('total_float_amount', 0.0))" /></p>
                            </td>
                        </tr>
                    </table>

                    <!-- Summary Table -->
                    <table class="table">
                        <tr>
                            <td class="fw-bold" style="width: 25%;">Total Float Amount</td>
                            <td style="width: 20%;">Rs. <span
                                    t-esc="'{:,.2f}'.format(reimbursement_info.get('total_float_amount', 0.0))" /></td>
                            <td class="fw-bold" style="width: 15%;">Remarks:</td>
                            <td style="width: 40%;">
                                <span t-esc="reimbursement_info.get('remarks', 'Monthly refill')" />
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Bills to Reimburse</td>
                            <td>Rs. <span
                                    t-esc="'{:,.2f}'.format(reimbursement_info.get('required_amount', 0.0))" /></td>
                            <td class="fw-bold">Justification:</td>
                            <td>
                                <span t-esc="reimbursement_info.get('justification', '')" />
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Cash in Hand</td>
                            <td>Rs. <span
                                    t-esc="'{:,.2f}'.format(reimbursement_info.get('current_balance', 0.0))" /></td>
                            <td colspan="2"></td>
                        </tr>
                    </table>

                    <!-- Expenses Breakdown -->
                    <h5>Expenses Breakdown</h5>

                    <!-- Petty Cash Table -->
                    <t t-if="petty_cash_data and len(petty_cash_data) > 0">
                        <h6>Petty Cash Requests</h6>
                        <table class="table">
                            <thead class="table-light">
                                <tr>
                                    <th>Request No</th>
                                    <th>Employee</th>
                                    <th>Department</th>
                                    <th>Category</th>
                                    <th style="text-align: right;">Amount</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="petty_cash_data" t-as="request">
                                    <tr>
                                        <td>
                                            <span t-esc="request['name']" />
                                        </td>
                                        <td>
                                            <span t-esc="request['request_by_name']" />
                                        </td>
                                        <td>
                                            <span t-esc="request['department_name']" />
                                        </td>
                                        <td>
                                            <span t-esc="request['category_name']" />
                                        </td>
                                        <td style="text-align: right;">Rs. <span
                                                t-esc="'{:,.2f}'.format(request['request_amount'])" /></td>
                                        <td>
                                            <span t-esc="request['request_date']" />
                                        </td>
                                        <td>
                                            <span t-esc="request['state']" />
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                            <tfoot class="table-info">
                                <tr>
                                    <td colspan="4" class="fw-bold">Total Petty Cash</td>
                                    <td style="text-align: right;" class="fw-bold">Rs. <span
                                            t-esc="'{:,.2f}'.format(report_summary.get('petty_cash_total', 0))" /></td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </t>

                    <!-- IOU Table -->
                    <t t-if="iou_data and len(iou_data) > 0">
                        <h6>IOU Requests</h6>
                        <table class="table">
                            <thead class="table-light">
                                <tr>
                                    <th>IOU No</th>
                                    <th>Employee</th>
                                    <th>Department</th>
                                    <th style="text-align: right;">Amount</th>
                                    <th>Date</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="iou_data" t-as="iou">
                                    <tr>
                                        <td>
                                            <span t-esc="iou['name']" />
                                        </td>
                                        <td>
                                            <span t-esc="iou['request_by_name']" />
                                        </td>
                                        <td>
                                            <span t-esc="iou['department_name']" />
                                        </td>
                                        <td style="text-align: right;">Rs. <span
                                                t-esc="'{:,.2f}'.format(iou['request_amount'])" /></td>
                                        <td>
                                            <span t-esc="iou['request_date']" />
                                        </td>
                                        <td>
                                            <span t-esc="iou['due_date']" />
                                        </td>
                                        <td>
                                            <span t-esc="iou['state']" />
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                            <tfoot class="table-info">
                                <tr>
                                    <td colspan="3" class="fw-bold">Total IOU</td>
                                    <td style="text-align: right;" class="fw-bold">Rs. <span
                                            t-esc="'{:,.2f}'.format(report_summary.get('iou_total', 0))" /></td>
                                    <td colspan="3"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </t>

                    <!-- Show message if no data -->
                    <t t-if="not petty_cash_data and not iou_data">
                        <div class="alert alert-primary text-center">
                            <p>No transactions found for the selected period.</p>
                        </div>
                    </t>

                    <!-- Grand Total -->
                    <div class="alert alert-primary">
                        <table style="width: 100%; margin: 0;">
                            <tr>
                                <td style="padding: 0;">
                                    <h5>Grand Total (Petty Cash + IOU)</h5>
                                </td>
                                <td style="text-align: right; padding: 0;">
                                    <h5>Rs. <span
                                            t-esc="'{:,.2f}'.format(report_summary.get('grand_total', 0))" /></h5>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Footer -->
                    <div class="text-center" style="margin-top: 10px;">
                        <small class="text-muted">Report generated on: <span
                                t-esc="datetime.datetime.now().strftime('%Y-%m-%d %H:%M')" /></small>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <record id="action_reimbursement_report" model="ir.actions.report">
        <field name="name">Reimbursement Report</field>
        <field name="model">cash.reimbursement</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">petty-cash.reimbursement_report_template</field>
        <field name="report_file">petty-cash.reimbursement_report_template</field>
        <field name="binding_model_id" ref="model_cash_reimbursement" />
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="paperformat_reimbursement_top" />
    </record>
</odoo>