<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ============================= -->
    <!-- Reimbursement Report Template -->
    <!-- ============================= -->
    <template id="reimbursement_report_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">

                    <!-- Get the active reimbursement record from docs (recordset) -->
                    <t t-set="reimbursement" t-value="docs and docs[0] or False" />

                    <!-- Lists passed via context in action_view_reimbursement_report -->
                    <t t-set="petty_cash_requests"
                        t-value="context.get('petty_cash_requests') or []" />
                    <t t-set="iou_requests" t-value="context.get('iou_requests') or []" />

                    <!-- Prefer raw values from data; fallback to model fields -->
                    <t t-set="report_from_date"
                        t-value="(data and data.get('from_date')) or (reimbursement and reimbursement.report_from_date)" />
                    <t t-set="report_to_date"
                        t-value="(data and data.get('to_date')) or (reimbursement and reimbursement.report_to_date)" />

                    <!-- Header -->
                    <div class="text-center">
                        <h3>GSMB Technical Services (PVT) LTD</h3>
                        <h4>Petty Cash Float Reimbursement Report</h4>
                        <p> (Period: <span t-esc="report_from_date or ''" /> - <span
                                t-esc="report_to_date or ''" />) </p>
                    </div>

                    <!-- Float Information -->
                    <div class="row mt-4">
                        <div class="col-6">
                            <p>
                                <strong>Float:</strong>
                                <span
                                    t-esc="reimbursement and reimbursement.float_request_id and reimbursement.float_request_id.name or ''" />
                            </p>
                            <p>
                                <strong>Handler Name:</strong>
                                <span
                                    t-esc="reimbursement and reimbursement.handler_name and reimbursement.handler_name.name or ''" />
                            </p>
                        </div>
                        <div class="col-6 text-right">
                            <p>
                                <strong>Total Float Amount:</strong> Rs. <span
                                    t-esc="reimbursement and reimbursement.float_request_id and '{:,.2f}'.format(reimbursement.float_request_id.initial_amount or 0.0) or '0.00'" />
                            </p>
                        </div>
                    </div>

                    <!-- Summary Table -->
                    <table class="table table-bordered mt-3">
                        <tr>
                            <td>
                                <strong>Total Float Amount</strong>
                            </td>
                            <td> Rs. <span
                                    t-esc="reimbursement and reimbursement.float_request_id and '{:,.2f}'.format(reimbursement.float_request_id.initial_amount or 0.0) or '0.00'" />
                            </td>
                            <td>
                                <strong>Remarks:</strong>
                                <span
                                    t-esc="reimbursement and reimbursement.remarks or 'Monthly refill'" />
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <strong>Bills to Reimburse</strong>
                            </td>
                            <td> Rs. <span
                                    t-esc="reimbursement and '{:,.2f}'.format(reimbursement.required_amount or 0.0) or '0.00'" />
                            </td>
                            <td>
                                <strong>Justification:</strong>
                                <span t-esc="reimbursement and reimbursement.justification or ''" />
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <strong>Cash in hand</strong>
                            </td>
                            <td> Rs. <span
                                    t-esc="reimbursement and '{:,.2f}'.format(reimbursement.current_balance or 0.0) or '0.00'" />
                            </td>
                            <td></td>
                        </tr>
                    </table>

                    <!-- Expenses Breakdown -->
                    <h5 class="mt-4">Expenses Breakdown:</h5>
                    <p>
                        <strong>Bills to Reimburse the Petty Cash Float</strong>
                    </p>

                    <!-- Debug information (remove in production) -->
                    <!-- <p>Debug: petty_cash_requests type: <span
                    t-esc="type(petty_cash_requests).__name__"/></p>
          <p>Debug: petty_cash_requests length: <span t-esc="len(petty_cash_requests) if petty_cash_requests
                    else 0"/></p> -->

                    <!-- Petty Cash Requests Table -->
                    <t t-if="petty_cash_requests and len(petty_cash_requests) > 0">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Request No</th>
                                    <th>Employee</th>
                                    <th>Department</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Approved By</th>
                                    <th>Receipt</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="petty_cash_requests" t-as="request">
                                    <tr>
                                        <td>
                                            <span t-esc="request.name or ''" />
                                        </td>
                                        <td>
                                            <span
                                                t-esc="request.request_by and request.request_by.name or ''" />
                                        </td>
                                        <td>
                                            <span
                                                t-esc="request.request_by and request.request_by.department_id and request.request_by.department_id.name or ''" />
                                        </td>
                                        <td>
                                            <span
                                                t-esc="request.category and request.category.name or ''" />
                                        </td>
                                        <td>Rs. <span
                                                t-esc="'{:,.2f}'.format(request.request_amount or 0.0)" /></td>
                                        <td>
                                            <span
                                                t-esc="request.request_date.strftime('%Y-%m-%d') if request.request_date else ''" />
                                        </td>
                                        <td>
                                            <span
                                                t-esc="'Manual' if request.request_voucher else 'Portal'" />
                                        </td>
                                        <td>
                                            <span
                                                t-esc="request.state and request.state.title() or ''" />
                                        </td>
                                        <td>
                                            <span
                                                t-esc="request.hodApprovedBy and request.hodApprovedBy.name or ''" />
                                        </td>
                                        <td>Receipt Link</td>
                                    </tr>
                                </t>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4">
                                        <strong>Total Petty Cash</strong>
                                    </td>
                                    <td>
                                        <strong>Rs. <span
                                                t-esc="'{:,.2f}'.format(sum(req.request_amount or 0 for req in petty_cash_requests))" /></strong>
                                    </td>
                                    <td colspan="5"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </t>
                    <t t-else="">
                        <p class="text-muted">No petty cash requests found for the selected period.</p>
                    </t>

                    <!-- IOU Requests Table -->
                    <t t-if="iou_requests and len(iou_requests) > 0">
                        <h6 class="mt-3">IOU Requests</h6>
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>IOU No</th>
                                    <th>Employee</th>
                                    <th>Department</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Due Date</th>
                                    <th>Approved By</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="iou_requests" t-as="iou">
                                    <tr>
                                        <td>
                                            <span t-esc="iou.name or ''" />
                                        </td>
                                        <td>
                                            <span
                                                t-esc="iou.request_by and iou.request_by.name or ''" />
                                        </td>
                                        <td>
                                            <span
                                                t-esc="iou.request_by and iou.request_by.department_id and iou.request_by.department_id.name or ''" />
                                        </td>
                                        <td>General</td>
                                        <td>Rs. <span
                                                t-esc="'{:,.2f}'.format(iou.request_amount or 0.0)" /></td>
                                        <td>
                                            <span
                                                t-esc="iou.request_date.strftime('%Y-%m-%d') if iou.request_date else ''" />
                                        </td>
                                        <td>
                                            <span
                                                t-esc="'Manual' if iou.request_voucher else 'Portal'" />
                                        </td>
                                        <td>
                                            <span
                                                t-esc="iou.due_date.strftime('%Y-%m-%d') if iou.due_date else ''" />
                                        </td>
                                        <td>
                                            <span
                                                t-esc="iou.hodApprovedBy and iou.hodApprovedBy.name or ''" />
                                        </td>
                                        <td>
                                            <span t-esc="iou.state and iou.state.title() or ''" />
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4">
                                        <strong>Total IOU</strong>
                                    </td>
                                    <td>
                                        <strong>Rs. <span
                                                t-esc="'{:,.2f}'.format(sum(iou.request_amount or 0 for iou in iou_requests))" /></strong>
                                    </td>
                                    <td colspan="5"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </t>
                    <t t-else="">
                        <p class="text-muted">No IOU requests found for the selected period.</p>
                    </t>

                    <!-- Grand Total -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <div class="row">
                                    <div class="col-8">
                                        <h5 class="mb-0">Grand Total (Petty Cash + IOU)</h5>
                                    </div>
                                    <div class="col-4 text-right">
                                        <h5 class="mb-0">
                                            <strong>Rs. <span
                                                    t-esc="'{:,.2f}'.format(
                        (sum(req.request_amount or 0 for req in petty_cash_requests) if petty_cash_requests else 0) + 
                        (sum(iou.request_amount or 0 for iou in iou_requests) if iou_requests else 0)
                      )" /></strong>
                                        </h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="mt-4">
                        <p>
                            <small> Report generated on: <span
                                    t-esc="datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')" />
                            </small>
                        </p>
                    </div>

                </div>
            </t>
        </t>
    </template>


    <record id="action_reimbursement_report" model="ir.actions.report">
        <field name="name">Reimbursement Report</field>
        <field name="model">cash.reimbursement</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">petty-cash.reimbursement_report_template</field>
        <field name="report_file">petty-cash.reimbursement_report_template</field>
        <field name="binding_model_id" ref="model_cash_reimbursement" />
        <field name="binding_type">report</field>
    </record>
</odoo>