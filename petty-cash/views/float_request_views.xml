<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="view_form_float_request_enhanced" model="ir.ui.view">
        <field name="name">float.request.form.enhanced</field>
        <field name="model">float.request</field>
        <field name="arch" type="xml">
            <form string="Create New Float" editable="top">
                <header>
                    <button name="action_submit" string="Submit for Approval"
                        type="object" class="btn-primary"
                        invisible="state != 'draft'" />
                    <button name="action_approve" string="Approve"
                        type="object" class="btn-success"
                        invisible="state != 'requested'"
                        groups="petty-cash.group_petty_cash_manager" />
                    <button name="action_reject" string="Reject"
                        type="object" class="btn-danger"
                        invisible="state != 'requested'"
                        groups="petty-cash.group_petty_cash_manager" />
                    <button name="action_setup_denominations" string="Setup Denominations"
                        type="object" class="btn-info"
                        invisible="state != 'approved' or current_denomination_id"
                        help="Setup initial cash denominations for this float" />
                    <button name="action_reset_to_draft" string="Reset to Draft"
                        type="object" class="btn-secondary"
                        invisible="state != 'rejected'" />
                    <field name="state" widget="statusbar"
                        statusbar_visible="draft,requested,approved" />
                </header>

                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_petty_cash_requests" type="object"
                            class="oe_stat_button" icon="fa-money">
                            <field name="total_petty_cash_requests" widget="statinfo"
                                string="Petty Cash Requests" />
                        </button>
                        <button name="action_view_iou_requests" type="object"
                            class="oe_stat_button" icon="fa-handshake-o">
                            <field name="total_iou_requests" widget="statinfo"
                                string="IOU Requests" />
                        </button>
                        <button name="action_view_denominations" type="object"
                            class="oe_stat_button" icon="fa-calculator"
                            invisible="not current_denomination_id">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_value">
                                    <field name="current_denomination_id" readonly="1" />
                                </span>
                                <span class="o_stat_text">Denominations</span>
                            </div>
                        </button>
                    </div>

                    <!-- Alert Messages -->
                    <div class="alert alert-info" invisible="state != 'draft'">
                        <div class="d-flex align-items-center">
                            <i class="fa fa-info-circle me-2"></i>
                            <div>
                                <strong>Draft Float Request</strong>
                                <p class="mb-0">Fill in all required fields. Attachment is optional. Submit for approval when ready.</p>
                            </div>
                        </div>
                    </div>

                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Float Name (e.g., Marketing Float)"
                                required="1" />
                        </h1>
                    </div>

                    <!-- Basic Information -->
                    <group string="Basic Information">
                        <group>
                            <field name="department_id"
                                options="{'no_create': True}"
                                required="1" />
                            <field name="float_manager_id"
                                options="{'no_create': True, 'no_edit': True}"
                                required="1"
                                context="{'default_department_id': department_id}" />
                            <field name="date_created" readonly="1" />
                        </group>
                        <group>
                            <field name="initial_amount" widget="monetary" required="1" />
                            <field name="max_single_disbursement" widget="monetary" />
                            <field name="allow_cross_department_request" />
                        </group>
                    </group>

                    <!-- Exceed Permissions -->
                    <group string="Disbursement Controls">
                        <group>
                            <field name="can_exceed" />
                            <field name="exceed_limit" widget="monetary"
                                invisible="not can_exceed"
                                required="can_exceed" />
                            <field name="exceed_margin_percentage"
                                invisible="not can_exceed" />
                        </group>
                        <group>
                            <field name="can_exceed_single_limit" />
                            <div class="alert alert-warning" invisible="not can_exceed">
                                <strong>Exceed Enabled:</strong> This float can disburse money over the initial limit up to Rs. <field name="exceed_limit" readonly="1" nolabel="1" />
                            </div>
                        </group>
                    </group>

                    <!-- Financial Summary -->
                    <group string="Financial Summary" invisible="state not in ['approved', 'completed']">
                        <group>
                            <field name="initial_amount" string="Initial Float" widget="monetary" readonly="1" />
                            <field name="total_disbursed" widget="monetary" readonly="1" />
                            <field name="current_amount" string="Current Balance" widget="monetary" readonly="1" />
                        </group>
                        <group>
                            <field name="iou_amount" string="Pending IOUs" widget="monetary" readonly="1" />
                            <field name="cash_in_hand" string="Cash in Hand" widget="monetary" readonly="1" />
                            <field name="available_for_disbursement" widget="monetary" readonly="1" />
                        </group>
                    </group>

                    <!-- Disbursement Limits Info -->
                    <div class="alert alert-info" invisible="state != 'approved'">
                        <h6>ðŸ’° Disbursement Information:</h6>
                        <ul class="mb-0">
                            <li><strong>Maximum Single Disbursement:</strong> Rs. <field name="max_single_disbursement" readonly="1" nolabel="1" /></li>
                            <li><strong>Can Exceed Single Limit:</strong> <field name="can_exceed_single_limit" readonly="1" nolabel="1" widget="boolean_toggle" /></li>
                            <li><strong>Available for New Requests:</strong> Rs. <field name="available_for_disbursement" readonly="1" nolabel="1" /></li>
                            <li invisible="not can_exceed"><strong>Total Limit (with exceed):</strong> Rs. <field name="exceed_limit" readonly="1" nolabel="1" /></li>
                        </ul>
                    </div>

                    <!-- Optional Attachment Section -->
                    <group string="Additional Information">
                        <group>
                            <field name="remarks" placeholder="Enter remarks (optional)" />
                        </group>
                        <group>
                            <field name="attachment" filename="attachment_filename" />
                            <field name="attachment_filename" invisible="1" />
                            <div class="text-muted small">
                                <i class="fa fa-info-circle"></i> Attachment is optional
                            </div>
                        </group>
                    </group>

                    <!-- Denomination Status -->
                    <group string="Denomination Status" invisible="state != 'approved'">
                        <div class="alert alert-info" invisible="current_denomination_id">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-exclamation-triangle me-2"></i>
                                <div>
                                    <strong>Denomination Setup Required</strong>
                                    <p class="mb-0">Click "Setup Denominations" to configure the initial cash breakdown for this float.</p>
                                </div>
                            </div>
                        </div>

                        <field name="denomination_ids" mode="list" readonly="1" invisible="not current_denomination_id">
                            <list decoration-success="total_amount > 0">
                                <field name="denom_5000_qty" string="Rs. 5,000" />
                                <field name="denom_1000_qty" string="Rs. 1,000" />
                                <field name="denom_500_qty" string="Rs. 500" />
                                <field name="denom_100_qty" string="Rs. 100" />
                                <field name="denom_50_qty" string="Rs. 50" />
                                <field name="denom_20_qty" string="Rs. 20" />
                                <field name="denom_10_qty" string="Rs. 10" />
                                <field name="denom_5_qty" string="Rs. 5" />
                                <field name="denom_2_qty" string="Rs. 2" />
                                <field name="denom_1_qty" string="Rs. 1" />
                                <field name="total_amount" widget="monetary" string="Total" />
                                <field name="last_updated" string="Last Updated" />
                            </list>
                        </field>
                    </group>

                    <!-- Hidden fields for computations -->
                    <field name="has_pending_customization" invisible="1" />
                    <field name="total_disbursed" invisible="1" />
                    <field name="available_for_disbursement" invisible="1" />
                </sheet>
            </form>
        </field>
    </record>

    <!-- Enhanced List View -->
    <record id="view_tree_float_request_enhanced" model="ir.ui.view">
        <field name="name">float.request.list.enhanced</field>
        <field name="model">float.request</field>
        <field name="arch" type="xml">
            <list string="Petty Cash Floats"
                  decoration-success="state == 'approved'"
                  decoration-warning="state == 'requested'"
                  decoration-info="state == 'draft'"
                  decoration-danger="state == 'rejected'">
                <field name="date_created" />
                <field name="name" />
                <field name="department_id" />
                <field name="float_manager_id" />
                <field name="initial_amount" widget="monetary" />
                <field name="available_for_disbursement" widget="monetary" />
                <field name="can_exceed" widget="boolean_toggle" />
                <field name="exceed_limit" widget="monetary" invisible="not can_exceed" />
                <field name="cash_in_hand" widget="monetary" />
                <field name="total_requests" />
                <field name="state" widget="badge" />
            </list>
        </field>
    </record>

    <!-- Enhanced Search View -->
    <record id="view_search_float_request_enhanced" model="ir.ui.view">
        <field name="name">float.request.search.enhanced</field>
        <field name="model">float.request</field>
        <field name="arch" type="xml">
            <search string="Search Petty Cash Floats">
                <field name="name" />
                <field name="department_id" />
                <field name="float_manager_id" />
                <field name="initial_amount" />

                <!-- Status Filters -->
                <filter string="Draft" name="draft" domain="[('state', '=', 'draft')]" />
                <filter string="Requested" name="requested" domain="[('state', '=', 'requested')]" />
                <filter string="Approved" name="approved" domain="[('state', '=', 'approved')]" />
                <filter string="Rejected" name="rejected" domain="[('state', '=', 'rejected')]" />

                <separator />
                <!-- Disbursement Filters -->
                <filter string="Can Exceed Limit" name="can_exceed" domain="[('can_exceed', '=', True)]" />
                <filter string="Cross Department Allowed" name="cross_dept" domain="[('allow_cross_department_request', '=', True)]" />
                <filter string="Low Balance" name="low_balance" domain="[('available_for_disbursement', '&lt;', 2000)]" />

                <separator />
                <!-- User Filters -->
                <filter string="My Requests" name="my_requests" domain="[('create_uid', '=', uid)]" />
                <filter string="My Managed Floats" name="my_managed" domain="[('float_manager_id', '=', uid)]" />

                <group expand="0" string="Group By">
                    <filter string="Status" name="group_status" context="{'group_by': 'state'}" />
                    <filter string="Department" name="group_department" context="{'group_by': 'department_id'}" />
                    <filter string="Float Manager" name="group_manager" context="{'group_by': 'float_manager_id'}" />
                    <filter string="Can Exceed" name="group_exceed" context="{'group_by': 'can_exceed'}" />
                    <filter string="Creation Date" name="group_date" context="{'group_by': 'date_created'}" />
                </group>
            </search>
        </field>
    </record>

    <!-- Enhanced Kanban View -->
    <record id="view_kanban_float_request_enhanced" model="ir.ui.view">
        <field name="name">float.request.kanban.enhanced</field>
        <field name="model">float.request</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_horizontal_floats" create="false" edit="false" delete="false">
                <field name="id" />
                <field name="name" />
                <field name="department_id" />
                <field name="initial_amount" />
                <field name="available_for_disbursement" />
                <field name="cash_in_hand" />
                <field name="iou_amount" />
                <field name="float_manager_id" />
                <field name="total_petty_cash_requests" />
                <field name="total_iou_requests" />
                <field name="total_requests" />
                <field name="date_created" />
                <field name="state" />
                <field name="can_exceed" />
<!--                <field name="exceed_limit" />-->
<!--                <field name="can_exceed_single_limit" />-->
                <field name="max_single_disbursement" />

                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_no_click"
                            t-attf-style="border-left: 4px solid {{record.state.value == 'approved' ? '#28a745' : record.state.value == 'requested' ? '#ffc107' : '#6c757d'}};">
                            <!-- Header -->
                            <div class="card-header">
                                <div>
                                    <strong t-esc="record.name.value" />
                                    <div class="text-muted small">
                                        <i class="fa fa-building me-1"></i>
                                        <t t-esc="record.department_id.value" />
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge"
                                        t-attf-class="badge-{{record.state.value == 'approved' ? 'success' : record.state.value == 'requested' ? 'warning' : 'secondary'}}">
                                        Rs. <t t-esc="record.initial_amount.value" />
                                    </span>
                                </div>
                            </div>

                            <!-- Financial Summary -->
                            <div class="float-card-summary">
                                <p class="text-primary">
                                    <span>Cash in Hand:</span>
                                    <span>Rs. <t t-esc="record.cash_in_hand.value" /></span>
                                </p>
                                <p class="text-warning">
                                    <span>IOU Amount:</span>
                                    <span>Rs. <t t-esc="record.iou_amount.value" /></span>
                                </p>
                                <p class="text-primary fw-bold">
                                    <span>Total Requests:</span>
                                    <span>
                                        <t t-esc="record.total_requests.value" />
                                    </span>
                                </p>
                                <p>
                                    <span><i class="fa fa-money text-info me-1"></i>Petty Cash:</span>
                                    <span>
                                        <t t-esc="record.total_petty_cash_requests.value" />
                                    </span>
                                </p>
                                <p>
                                    <span><i class="fa fa-handshake-o text-warning me-1"></i>IOU:</span>
                                    <span>
                                        <t t-esc="record.total_iou_requests.value" />
                                    </span>
                                </p>
                                <p class="text-info">
                                    <span>Max Single Disbursement:</span>
                                    <span>Rs. <t t-esc="record.max_single_disbursement.value" /></span>

                                </p>
                            </div>

                            <!-- Disbursement Controls Info -->
                            <div class="mt-2 small">
                                <div t-if="record.can_exceed.value" class="text-success">
                                    <i class="fa fa-check-circle me-1"></i>Can exceed initial limit
                                </div>
                                <div t-if="!record.can_exceed.value" class="text-muted">
                                    <i class="fa fa-lock me-1"></i>Cannot exceed initial limit
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="float-card-buttons">
                                <button type="object" name="action_view_petty_cash_requests"
                                    class="btn btn-outline-primary btn-sm"
                                    t-attf-context="{'search_default_float_request_id': {{record.id.raw_value}}, 'default_float_request_id': {{record.id.raw_value}}}">
                                    <i class="fa fa-money me-1"></i>Petty Cash
                                </button>
                                <button type="object" name="action_view_iou_requests"
                                    class="btn btn-outline-warning btn-sm"
                                    t-attf-context="{'search_default_float_request_id': {{record.id.raw_value}}, 'default_float_request_id': {{record.id.raw_value}}}">
                                    <i class="fa fa-handshake-o me-1"></i>IOU
                                </button>
                                <button type="object" name="action_request_reimbursement"
                                    class="btn btn-outline-success btn-sm">
                                    <i class="fa fa-refresh me-1"></i>Reimburse
                                </button>
                            </div>

                            <!-- Footer Info -->
                            <div class="mt-2 pt-2 border-top">
                                <div class="d-flex justify-content-between text-muted small">
                                    <span>
                                        <i class="fa fa-user me-1"></i>
                                        <t t-esc="record.float_manager_id.value" />
                                    </span>
                                    <span>
                                        <i class="fa fa-calendar me-1"></i>
                                        <t t-esc="record.date_created.value" />
                                    </span>
                                </div>
                            </div>

                            <!-- Low Balance Alert -->
<!--                            <div class="alert alert-warning py-2 mt-2 mb-0 small"-->
<!--                                t-if="record.available_for_disbursement.value &lt; 2000">-->
<!--                                <i class="fa fa-exclamation-triangle me-1"></i> Low balance warning-->
<!--                            </div>-->
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Action with Enhanced Views -->
    <record id="action_float_request" model="ir.actions.act_window">
        <field name="name">Petty Cash Floats</field>
        <field name="res_model">float.request</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="view_ids" eval="[(5, 0, 0),
                                      (0, 0, {'view_mode': 'kanban', 'view_id': ref('view_kanban_float_request_enhanced')}),
                                      (0, 0, {'view_mode': 'list', 'view_id': ref('view_tree_float_request_enhanced')}),
                                      (0, 0, {'view_mode': 'form', 'view_id': ref('view_form_float_request_enhanced')})]" />
        <field name="search_view_id" ref="view_search_float_request_enhanced" />
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first float request!
            </p>
            <p>
                Floats are used to manage petty cash for different departments.<br />
                â€¢ Set disbursement limits and exceed permissions<br />
                â€¢ Assign department-specific float managers<br />
                â€¢ Attachment is optional<br />
                Click "Create" to set up a new petty cash float.
            </p>
        </field>
    </record>
</odoo>