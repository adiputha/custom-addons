<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Tree view for IOU bill settlement -->
    <record id="iou_bill_settlement_tree_view" model="ir.ui.view">
        <field name="name">iou.bill.settlement.list</field>
        <field name="model">iou.bill.settlement</field>
        <field name="arch" type="xml">
            <list editable="bottom">
                <field name="date" />
                <field name="category" />
                <field name="amount" sum="Total Amount" />
                <field name="receipt" filename="receipt_filename" />
                <!-- <field name="receipt_filename" invisible="1" /> -->
                <field name="action" widget="selection"
                    readonly="parent.state != 'pending_bill_submission'" />
                <field name="status" readonly="1" />
                <field name="remarks"
                    readonly="parent.state != 'pending_bill_submission'" />
            </list>
        </field>

    </record>
    <!-- List view -->
    <record id="iou_request_tree_view" model="ir.ui.view">
        <field name="model">petty.cash.iou.request</field>
        <field name="name">petty.cash.iou.request.list</field>
        <field name="arch" type="xml">
            <list string="IOU Requests"
                decoration-success="state == 'completed'"
                decoration-info="state == 'pending_bill_submission'"
                decoration-warning="state in ['requested', 'hod_approval_pending', 'float_manager_approval_pending']"
                decoration-muted="state == 'draft'"
                decoration-danger="state in ['cancelled', 'hod_rejected', 'float_manager_rejected']">
                <field name="request_date" />
                <field name="name" string="IOU No" />
                <field name="float_request_id" string="Float Name" />
                <field name="request_by" string="Requested By" />
                <field name="request_amount" string="Amount" />
                <field name="due_date" string="Due Date" />
                <field name="hodApprovedBy" string="HOD Approved By" />
                <field name="floatManagerApprovedBy" string="Float Manager Approved By" />
                <field name="state" string="Status" widget="badge" />
            </list>
        </field>
    </record>

    <!-- Form view -->
    <record id="iou_request_form_view" model="ir.ui.view">
        <field name="name">petty.cash.iou.request.form</field>
        <field name="model">petty.cash.iou.request</field>
        <field name="priority">1</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_submit" string="Submit" type="object"
                        class="btn-primary"
                        invisible="state != 'draft'" />
                    <button name="action_cancel" string="Cancel Request" type="object"
                        invisible="state not in ['draft', 'requested']" />
                    <button name="action_cash_issued" string="Cash Issued" type="object"
                        class="btn-primary"
                        invisible="state != 'requested'"
                        groups="base.group_user" />
                    <button name="action_complete_iou" string="Complete Request" type="object"
                        class="btn-success"
                        invisible="state != 'pending_bill_submission'" />
                    <field name="state" widget="statusbar"
                        statusbar_visible="draft,requested,pending_bill_submission,completed" />
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1" />
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="request_by" string="Request By" />
                            <!-- <field name="employee_dept" string="Employee Dept" /> -->
                            <field name="float_request_id"
                                domain="[('state', '=', 'approved')]"
                                options="{'no_create': True}" />
                            <field name="request_date" string="Request Date" />
                            <field name="due_date" string="Due Date" />
                            <field name="request_voucher" filename="request_voucher_name" />
                            <field name="request_voucher_name" invisible="1" />
                            <field name="reason_in_advance" string="Reason in Advance" />
                        </group>
                        <group>
                            <field name="request_amount" string="Request Amount"
                                widget="monetary" />
                            <field name="isHodApproved" string="Is HOD Approved" />
                            <field name="hodApprovedBy" string="HOD Approved By"
                                invisible="not isHodApproved" />
                            <field name="isFloatManagerApproved" string="Is Float Manager Approved" />
                            <field name="floatManagerApprovedBy" string="Float Manager Approved By"
                                invisible="not isFloatManagerApproved" />
                            <field name="cashReceivedByEmployee"
                                invisible="state not in ['cash_issued', 'completed']" />
                            <field name="received_voucher"
                                invisible="state not in ['cash_issued', 'completed']" />

                        </group>
                    </group>

                    <group>
                        <field name="remarks" string="Remarks" />
                    </group>


                    <group string="IOU Bill Settlements"
                        invisible="state not in ['pending_bill_submission', 'completed']">
                        <group>
                            <button name="action_approve_selected"
                                string="Approve Selected"
                                type="object"
                                class="btn-success"
                                invisible="state != 'pending_bill_submission'" />
                            <button name="action_reject_selected"
                                string="Reject Selected"
                                type="object"
                                class="btn-warning"
                                invisible="state != 'pending_bill_submission'" />
                        </group>

                    </group>
                    <field name="bill_ids"
                        invisible="state not in ['pending_bill_submission', 'completed']"
                        mode="list,form"
                        domain="[]"
                        views="[(list, 'iou_bill_settlement_tree_view')]"
                        context="{'default_iou_request_id': id}">

                    </field>
                </sheet>


            </form>
        </field>
    </record>

    <!-- Search view -->
    <record id="iou_request_search_view" model="ir.ui.view">
        <field name="name">petty.cash.iou.request.search</field>
        <field name="model">petty.cash.iou.request</field>
        <field name="arch" type="xml">
            <search string="Search IOU Requests">
                <field name="name" />
                <field name="request_by" />
                <field name="request_amount" />
                <field name="reason_in_advance" />
                <separator />


                <filter name="approved" string="Approved"
                    domain="[('state', 'in', ['hod_approved', 'float_manager_approved'])]" />
                <filter name="pending_bill_submission" string="Pending Bill Submission"
                    domain="[('state', '=', 'pending_bill_submission')]" />
                <filter name="completed" string="Completed"
                    domain="[('state', '=', 'completed')]" />
                <filter name="overdue" string="Overdue"
                    domain="[('due_date', '&lt;', context_today().strftime('%Y-%m-%d')), ('state', 'not in', ['completed', 'cancelled'])]" />
                <separator />
                <group expand="0" string="Group By">
                    <filter name="group_by_state" string="Status"
                        context="{'group_by': 'state'}" />
                    <filter name="group_by_requester" string="Requested By"
                        context="{'group_by': 'request_by'}" />
                    <filter name="group_by_request_date" string="Request Date"
                        context="{'group_by': 'request_date'}" />
                    <filter name="group_by_due_date" string="Due Date"
                        context="{'group_by': 'due_date'}" />
                    <filter name="filter_by_float" string="Float Name"
                        domain="[]" context="{'group_by': 'float_request_id'}" />
                </group>
            </search>
        </field>
    </record>

    <!-- Window action -->
    <record id="action_iou_requests" model="ir.actions.act_window">
        <field name="name">IOU Requests</field>
        <field name="res_model">petty.cash.iou.request</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="iou_request_search_view" />
        <field name="domain">[('float_request_id', '=',
            context.get('search_default_float_request_id'))]</field>
        <field name="context">{'default_request_type': 'iou'}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create IOU Requests
            </p>
            <p>
                Click "New" to create a new IOU request for advance payments.
                IOU requests require approval from HOD and Float Manager before cash can be issued.
            </p>
        </field>
    </record>
</odoo>